name: "Build"
description: "Action to build Node.js projects with support for custom commands, environment variables, and artifact handling"
author: Hoverkraft
branding:
  icon: package
  color: gray-dark

inputs:
  working-directory:
    description: |
      Working directory where the build commands are executed.
      Can be absolute or relative to the repository root.
    required: false
    default: "."
  build-commands:
    description: |
      List of build commands to execute, one per line.
      These are npm/pnpm/yarn script names (e.g., "build", "compile").
    required: true
  build-env:
    description: |
      JSON object of environment variables to set during the build.
      Example: {"NODE_ENV": "production", "API_URL": "https://api.example.com"}
    required: false
    default: "{}"
  build-secrets:
    description: |
      Multi-line string of secrets in env format (KEY=VALUE).
      Example:
      ```
      SECRET_KEY=${{ secrets.SECRET_KEY }}
      API_TOKEN=${{ secrets.API_TOKEN }}
      ```
    required: false
    default: ""
  build-artifact:
    description: |
      JSON object specifying artifact upload configuration.
      Format: {"name": "artifact-name", "paths": "path1\npath2"}
    required: false
    default: ""
  container:
    description: "Whether running in container mode (skips checkout and node setup)"
    required: false
    default: "false"

outputs:
  artifact-id:
    description: "ID of the uploaded artifact (if artifact was specified)"
    value: ${{ steps.build-artifact-id.outputs.artifact-id }}

runs:
  using: "composite"
  steps:
    - shell: bash
      # FIXME: workaround until will be merged: https://github.com/actions/runner/pull/1684
      run: mkdir -p ./self-build-action/ && cp -r $GITHUB_ACTION_PATH/../* ./self-build-action/

    - id: setup-node
      if: inputs.container != 'true'
      uses: ./self-build-action/setup-node
      with:
        working-directory: ${{ inputs.working-directory }}
        dependencies-cache: |
          nx
          gatsby
          storybook

    - id: get-package-manager
      if: inputs.container == 'true'
      uses: ./self-build-action/get-package-manager
      with:
        working-directory: ${{ inputs.working-directory }}

    - shell: bash
      env:
        BUILD_ENV: ${{ inputs.build-env }}
        BUILD_SECRETS: ${{ inputs.build-secrets }}
      run: |
        set -e

        # Export build environment variables
        BUILD_ENV_JSON="${BUILD_ENV:-"{}"}"

        # Parse and export build env variables
        if [ "$BUILD_ENV_JSON" != "{}" ]; then
          echo "$BUILD_ENV_JSON" | jq -r 'to_entries[] | "\(.key)=\(.value)"' | while IFS= read -r line; do
            if [ -n "$line" ]; then
              echo "$line" >> $GITHUB_ENV
            fi
          done
        fi

        # Export build secrets
        if [ -n "$BUILD_SECRETS" ]; then
          echo "$BUILD_SECRETS" | while IFS= read -r line; do
            line=$(echo "$line" | xargs)
            if [ -n "$line" ]; then
              echo "$line" >> $GITHUB_ENV
            fi
          done
        fi

    - shell: bash
      working-directory: ${{ inputs.working-directory }}
      env:
        BUILD_COMMANDS: ${{ inputs.build-commands }}
        RUN_SCRIPT_COMMAND: ${{ inputs.container == 'true' && steps.get-package-manager.outputs.run-script-command || steps.setup-node.outputs.run-script-command }}
      run: |
        set -e

        echo "$BUILD_COMMANDS" | while IFS= read -r COMMAND ; do
          # Trim whitespace
          COMMAND=$(echo "$COMMAND" | xargs)
          
          # Skip empty lines
          if [ -z "$COMMAND" ]; then
            continue
          fi
          
          echo -e "\nüèóÔ∏è Running build command: $COMMAND"
          $RUN_SCRIPT_COMMAND "$COMMAND"
        done

    - id: build-artifact-id
      if: inputs.build-artifact != ''
      uses: actions/upload-artifact@330a01c490aca151604b8cf639adc76d48f6c5d4 # v5.0.0
      with:
        name: ${{ fromJSON(inputs.build-artifact).name }}
        path: ${{ fromJSON(inputs.build-artifact).paths }}
        if-no-files-found: error

    # FIXME: workaround until will be merged: https://github.com/actions/runner/pull/1684
    - shell: bash
      if: always()
      run: rm -fr ./self-build-action
