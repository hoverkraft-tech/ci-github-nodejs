name: "Lint"
description: "Action to lint Node.js projects with support for pull request reporting and annotations"
author: hoverkraft
branding:
  icon: check-circle
  color: blue

inputs:
  working-directory:
    description: |
      Working directory where lint commands are executed.
      Can be absolute or relative to the repository root.
    required: false
    default: "."
  container:
    description: "Whether running in container mode (skips checkout and node setup)"
    required: false
    default: "false"
  command:
    description: |
      NPM/package manager script command to run for linting.
      This should be a script defined in your package.json.
      The command should generate lint report files in a standard format.
    required: false
    default: "lint:ci"
  report-file:
    description: |
      Optional lint report path forwarded to the [parse-ci-reports](https://hoverkraft-tech/ci-github-common/actions/parse-ci-reports) action.
      Provide an absolute path or one relative to the working directory.
      When omitted, the action falls back to "auto:lint" detection.
    required: false
    default: ""
  path-mapping:
    description: |
      Optional path mapping to adjust file paths in test and coverage reports.
      See the [parse-ci-reports documentation](https://hoverkraft-tech/ci-github-common/actions/parse-ci-reports) for details.
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - shell: bash
      # FIXME: workaround until will be merged: https://github.com/actions/runner/pull/1684
      run: mkdir -p ./self-lint-action/ && cp -r $GITHUB_ACTION_PATH/../* ./self-lint-action/

    - id: setup-node
      if: inputs.container != 'true'
      uses: ./self-lint-action/setup-node
      with:
        working-directory: ${{ inputs.working-directory }}
        dependencies-cache: |
          nx
          prettier

    - id: get-package-manager
      if: inputs.container == 'true'
      uses: ./self-lint-action/get-package-manager
      with:
        working-directory: ${{ inputs.working-directory }}

    - id: run-lint
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      env:
        RUN_LINT_COMMAND: ${{ inputs.container == 'true' && steps.get-package-manager.outputs.run-script-command || steps.setup-node.outputs.run-script-command }}
        WORKING_DIRECTORY: ${{ inputs.working-directory }}
        LINT_COMMAND: ${{ inputs.command }}
      with:
        script: |
          const fs = require('node:fs');
          const path = require('node:path');

          const runScriptCommand = process.env.RUN_LINT_COMMAND;
          const lintCommand = process.env.LINT_COMMAND || 'lint:ci';

          let workingDirectory = process.env.WORKING_DIRECTORY || '.';
          if (!path.isAbsolute(workingDirectory)) {
            workingDirectory = path.join(process.env.GITHUB_WORKSPACE, workingDirectory);
          }

          if (!fs.existsSync(workingDirectory)) {
            core.setFailed(`The specified working directory does not exist: ${workingDirectory}`);
            return;
          }

          workingDirectory = path.resolve(workingDirectory);
          core.debug(`Running in working directory: ${workingDirectory}`);
          process.chdir(workingDirectory);

          core.info(`ðŸ‘• Running lint command: ${lintCommand}...`);

          try {
            const exitCode = await exec.exec(runScriptCommand, [lintCommand], {
              cwd: workingDirectory,
              ignoreReturnCode: true
            });

            core.setOutput('lint-exit-code', exitCode);

            if (exitCode !== 0) {
              core.setFailed(`Linting failed with exit code ${exitCode}`);
            }
          } catch (error) {
            core.setOutput('lint-exit-code', 1);
            core.setFailed(`Linting error: ${error.message}`);
          }

    - name: ðŸ“Š Parse lint reports
      if: always()
      uses: hoverkraft-tech/ci-github-common/actions/parse-ci-reports@c314229c3ca6914f7023ffca7afc26753ab99b41 # 0.30.1
      with:
        working-directory: ${{ inputs.working-directory }}
        report-paths: ${{ inputs.report-file || 'auto:lint' }}
        path-mapping: ${{ inputs.path-mapping }}
        report-name: "Lint Results"
        output-format: "annotations,summary"

    # FIXME: workaround until will be merged: https://github.com/actions/runner/pull/1684
    - shell: bash
      if: always()
      run: rm -fr ./self-lint-action
