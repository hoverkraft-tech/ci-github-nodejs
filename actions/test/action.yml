name: "Test"
description: "Action to test Node.js projects with support for coverage reporting and pull request annotations"
author: hoverkraft
branding:
  icon: check-square
  color: blue

inputs:
  working-directory:
    description: |
      Working directory where test commands are executed.
      Can be absolute or relative to the repository root.
    required: false
    default: "."
  container:
    description: "Whether running in container mode (skips checkout and node setup)"
    required: false
    default: "false"
  command:
    description: |
      npm/pnpm/Yarn script command to run for testing.
      This should be a script defined in your `package.json`.
      The command should generate coverage report files in a standard format (Cobertura XML, lcov, etc.).

      Vitest: `vitest run --reporter=default --reporter=junit --outputFile=junit.xml --coverage.enabled --coverage.reporter=lcov --coverage.reporter=text`
      Jest: `jest --ci --reporters=default --reporters=jest-junit --coverage`
    required: false
    default: "test:ci"
  coverage:
    description: |
      Code coverage reporter to use. Supported values:
      - `github`: Parse coverage reports via [parse-ci-reports](https://github.com/hoverkraft-tech/ci-github-common/tree/main/actions/parse-ci-reports) action, with GitHub summaries/PR comments
      - `codecov`: Upload coverage to Codecov
      - `""` or `null`: No coverage reporting
    required: false
    default: "github"
  report-file:
    description: |
      Optional test and coverage report paths forwarded to the [parse-ci-reports](https://github.com/hoverkraft-tech/ci-github-common/tree/main/actions/parse-ci-reports) action.
      Supports multiple formats (Cobertura, OpenCover, lcov, etc.).
      Provide absolute paths or paths relative to the working directory.
      Multiple entries can be separated by newlines, commas, or semicolons.
      When omitted, the action falls back to `auto:test,auto:coverage` detection.
    required: false
    default: ""
  path-mapping:
    description: |
      Optional path mapping to adjust file paths in test and coverage reports.
      See the [parse-ci-reports documentation](https://hoverkraft-tech/ci-github-common/actions/parse-ci-reports) for details.
    required: false
    default: ""
  github-token:
    description: |
      GitHub token for coverage PR comments.
      Required when coverage is set to `github`.
      Requires permissions to create and update PR comments:

      - `issues: write`
      - `pull-requests: write`
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - shell: bash
      # FIXME: workaround until will be merged: https://github.com/actions/runner/pull/1684
      run: mkdir -p ./self-test-action/ && cp -r $GITHUB_ACTION_PATH/../* ./self-test-action/

    - id: setup-node
      if: inputs.container != 'true'
      uses: ./self-test-action/setup-node
      with:
        working-directory: ${{ inputs.working-directory }}
        dependencies-cache: |
          nx
          jest
          vitest

    - id: get-package-manager
      if: inputs.container == 'true'
      uses: ./self-test-action/get-package-manager
      with:
        working-directory: ${{ inputs.working-directory }}

    - id: run-test
      name: ðŸ§ª Run tests
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      env:
        RUN_TEST_COMMAND: ${{ inputs.container == 'true' && steps.get-package-manager.outputs.run-script-command || steps.setup-node.outputs.run-script-command }}
        WORKING_DIRECTORY: ${{ inputs.working-directory }}
        TEST_COMMAND: ${{ inputs.command }}
      with:
        script: |
          const fs = require('node:fs');
          const workingDirectory = process.env.WORKING_DIRECTORY;
          if (!fs.existsSync(workingDirectory)) {
            core.setFailed(`The specified working directory does not exist: ${workingDirectory}`);
            return;
          }
          core.debug(`Running in working directory: ${workingDirectory}`);
          process.chdir(workingDirectory);

          const runScriptCommand = process.env.RUN_TEST_COMMAND;
          const testCommand = process.env.TEST_COMMAND || 'test:ci';


          core.info(`ðŸ§ª Running test command: ${testCommand}...`);

          try {
            const exitCode = await exec.exec(runScriptCommand, [testCommand], {
              cwd: workingDirectory,
              env: { ...process.env, CI: 'true' },
              ignoreReturnCode: true
            });

            core.setOutput('test-exit-code', exitCode);

            if (exitCode !== 0) {
              core.setFailed(`Tests failed with exit code ${exitCode}`);
            }
          } catch (error) {
            core.setOutput('test-exit-code', 1);
            core.setFailed(`Test execution error: ${error.message}`);
          }

    - name: ðŸ“Š Parse coverage reports
      if: always() && inputs.coverage == 'github'
      id: parse-coverage-reports
      uses: hoverkraft-tech/ci-github-common/actions/parse-ci-reports@5e8d0e6d1e76d8577a070db6d0128a91b1c9d5ad # 0.30.2
      with:
        working-directory: ${{ inputs.working-directory }}
        report-name: "Coverage Results"
        report-paths: ${{ inputs.report-file || 'auto:test,auto:coverage' }}
        path-mapping: ${{ inputs.path-mapping }}
        output-format: "summary,markdown"

    - name: ðŸ“Š Add coverage PR comment
      if: always() && inputs.coverage == 'github' && github.event_name == 'pull_request' && steps.parse-coverage-reports.outputs.markdown
      uses: hoverkraft-tech/ci-github-common/actions/create-or-update-comment@5e8d0e6d1e76d8577a070db6d0128a91b1c9d5ad # 0.30.2
      with:
        title: "Code Coverage Report"
        body: ${{ steps.parse-coverage-reports.outputs.markdown }}

    - name: ðŸ“Š Upload coverage to Codecov
      if: always() && inputs.coverage == 'codecov'
      uses: ./self-test-action/codecov
      with:
        working-directory: ${{ inputs.working-directory }}
        container: ${{ inputs.container }}

    # FIXME: workaround until will be merged: https://github.com/actions/runner/pull/1684
    - shell: bash
      if: always()
      run: rm -fr ./self-test-action
