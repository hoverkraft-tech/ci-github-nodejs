name: "Test"
description: "Action to test Node.js projects with support for coverage reporting and pull request annotations"
author: hoverkraft
branding:
  icon: check-square
  color: blue

inputs:
  working-directory:
    description: |
      Working directory where test commands are executed.
      Can be absolute or relative to the repository root.
    required: false
    default: "."
  container:
    description: "Whether running in container mode (skips checkout and node setup)"
    required: false
    default: "false"
  command:
    description: |
      NPM/package manager script command to run for testing.
      This should be a script defined in your package.json.
      The command should generate coverage report files in a standard format (Cobertura XML, lcov, etc.).
    required: false
    default: "test:ci"
  coverage:
    description: |
      Code coverage reporter to use. Supported values:
      - `github`: Parse coverage reports via [parse-ci-reports](https://hoverkraft-tech/ci-github-common/actions/parse-ci-reports) action, with GitHub summaries/PR comments
      - `codecov`: Upload coverage to Codecov
      - `""` or `null`: No coverage reporting
    required: false
    default: "github"
  coverage-files:
    description: |
      Optional coverage report paths forwarded to the hoverkraft-tech/ci-github-common/actions/parse-ci-reports action.
      Supports multiple formats (Cobertura, OpenCover, lcov, etc.).
      Provide absolute paths or paths relative to the working directory.
      Multiple entries can be separated by newlines, commas, or semicolons.
      When omitted, the action falls back to "auto:test" detection (LCOV / Cobertura / Clover).
    required: false
    default: ""
  github-token:
    description: |
      GitHub token for coverage PR comments.
      Required when coverage is set to `github`.
    required: false
    default: ""

runs:
  using: "composite"
  steps:
    - shell: bash
      # FIXME: workaround until will be merged: https://github.com/actions/runner/pull/1684
      run: mkdir -p ./self-test-action/ && cp -r $GITHUB_ACTION_PATH/../* ./self-test-action/

    - id: setup-node
      if: inputs.container != 'true'
      uses: ./self-test-action/setup-node
      with:
        working-directory: ${{ inputs.working-directory }}
        dependencies-cache: |
          nx
          jest

    - id: get-package-manager
      if: inputs.container == 'true'
      uses: ./self-test-action/get-package-manager
      with:
        working-directory: ${{ inputs.working-directory }}

    - id: run-test
      name: ðŸ§ª Run tests
      uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8.0.0
      env:
        RUN_TEST_COMMAND: ${{ inputs.container == 'true' && steps.get-package-manager.outputs.run-script-command || steps.setup-node.outputs.run-script-command }}
        WORKING_DIRECTORY: ${{ inputs.working-directory }}
        TEST_COMMAND: ${{ inputs.command }}
      with:
        script: |
          const workingDirectory = process.env.WORKING_DIRECTORY || '.';
          const runScriptCommand = process.env.RUN_TEST_COMMAND;
          const testCommand = process.env.TEST_COMMAND || 'test:ci';

          core.info(`ðŸ§ª Running test command: ${testCommand}...`);

          try {
            const result = await exec.getExecOutput(runScriptCommand, [testCommand], {
              cwd: require('path').resolve(process.env.GITHUB_WORKSPACE, workingDirectory),
              env: { ...process.env, CI: 'true' },
              ignoreReturnCode: true
            });

            if (result.stdout) core.info(result.stdout);
            if (result.stderr) core.warning(result.stderr);

            core.setOutput('test-exit-code', result.exitCode);

            if (result.exitCode !== 0) {
              core.setFailed(`Tests failed with exit code ${result.exitCode}`);
            }
          } catch (error) {
            core.setOutput('test-exit-code', 1);
            core.setFailed(`Test execution error: ${error.message}`);
          }

    - name: ðŸ“Š Parse coverage reports
      if: always() && inputs.coverage == 'github'
      id: parse-coverage-reports
      uses: hoverkraft-tech/ci-github-common/actions/parse-ci-reports@c314229c3ca6914f7023ffca7afc26753ab99b41 # 0.30.1
      with:
        report-paths: ${{ inputs.coverage-files || 'auto:test' }}
        report-name: "Coverage Results"
        output-format: "summary,markdown"

    - name: ðŸ“Š Add coverage PR comment
      if: always() && inputs.coverage == 'github' && github.event_name == 'pull_request' && steps.parse-coverage-reports.outputs.markdown
      uses: hoverkraft-tech/ci-github-common/actions/create-or-update-comment@c314229c3ca6914f7023ffca7afc26753ab99b41 # 0.30.1
      with:
        title: "Code Coverage Report"
        body: ${{ steps.parse-coverage-reports.outputs.markdown }}

    # Install dependencies for codecov in container mode
    - name: Install Codecov dependencies
      if: inputs.coverage == 'codecov' && inputs.container == 'true'
      uses: pkgxdev/setup@f211ee4db3110b42e5a156282372527e7c1ed723 # v4.0.0
      with:
        +: git curl gnupg.org

    - name: ðŸ“Š Upload coverage to Codecov
      if: always() && inputs.coverage == 'codecov'
      uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7 # v5.5.1
      with:
        working-directory: ${{ inputs.working-directory }}
        use_oidc: true
        disable_telem: true
        fail_ci_if_error: false

    # FIXME: workaround until will be merged: https://github.com/actions/runner/pull/1684
    - shell: bash
      if: always()
      run: rm -fr ./self-test-action
